---
import Layout from '../layouts/Layout.astro';
import { SITE_DATA } from '../constants';
import publicationsData from '../data/publications.json';

import '../styles/global.css';

// Extract years for filters
const years = [...new Set(publicationsData.map(pub => pub.year))].sort((a, b) => b - a);
const minYear = Math.min(...years);
const maxYear = Math.max(...years);

// Extract unique publication types
const publicationTypes = [...new Set(publicationsData.map(pub => pub.publicationType).filter(Boolean))];
---

<Layout pageTitle="Publications">
    <div class="page-container">
        <h1>Publications</h1>

        <div class="info-card">
            <p>
                For an up-to-date list of my peer-reviewed publications and preprints, see:
            </p>
            <a href={`https://scholar.google.com/citations?user=${SITE_DATA.scholar}`}
               class="info-card-link"
               target="_blank"
               rel="noopener noreferrer"
               aria-label="Visit Google Scholar profile">
                <svg viewBox="0 0 24 24" width="60" height="60" fill="currentColor">
                    <path d="M12 2L1 7l11 5 9-4.09V17h2V7L12 2z"></path>
                    <path d="M19 11v6c0 1.66-3.13 3-7 3s-7-1.34-7-3v-6l7 3 7-3z"></path>
                </svg>
                <span>Google Scholar</span>
            </a>
        </div>

        <div class="publications-section">
            <!-- Controls -->
            <div class="controls-wrapper">
                <button class="controls-toggle-btn" id="controls-toggle" aria-expanded="true" aria-label="Toggle filters">
                    <span class="toggle-label">Filters</span>
                    <svg class="toggle-arrow" viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                        <path d="M7 10l5 5 5-5z"/>
                    </svg>
                </button>
                <div class="controls-container" id="controls-container">
                <!-- Search -->
                <div class="control-section">
                    <label class="section-label">Search</label>
                    <input
                        type="text"
                        id="search-input"
                        class="search-input"
                        placeholder="Keywords (comma-separated)"
                    />
                </div>

                <!-- Filters Row -->
                <div class="filters-row">
                    <!-- Sort -->
                    <div class="control-section">
                        <label class="section-label">Sort</label>
                        <div class="sort-buttons">
                            <button class="sort-btn active" data-sort="year-desc">Newest</button>
                            <button class="sort-btn" data-sort="year-asc">Oldest</button>
                            <button class="sort-btn" data-sort="title">A-Z</button>
                        </div>
                    </div>

                    <!-- Authorship -->
                    <div class="control-section">
                        <label class="section-label">Authorship</label>
                        <div class="authorship-filters">
                            <button class="filter-chip active" data-authorship="all">All</button>
                            <button class="filter-chip" data-authorship="lead">First/Last</button>
                            <button class="filter-chip" data-authorship="other">Co</button>
                        </div>
                    </div>

                    <!-- Publication Type -->
                    <div class="control-section">
                        <label class="section-label">Type</label>
                        <div class="type-filters">
                            <button class="filter-chip active" data-type="all">All</button>
                            {publicationTypes.map(type => (
                                <button class="filter-chip" data-type={type}>{type}</button>
                            ))}
                        </div>
                    </div>
                </div>

                <!-- Year Range -->
                <div class="control-section">
                    <label class="section-label">Year Range</label>
                    <div class="year-slider-container">
                        <input type="range" id="year-min" class="year-slider" min={minYear} max={maxYear} value={minYear} />
                        <input type="range" id="year-max" class="year-slider" min={minYear} max={maxYear} value={maxYear} />
                        <div class="year-track"></div>
                        <div class="year-labels">
                            <span id="year-min-label">{minYear}</span>
                            <span id="year-max-label">{maxYear}</span>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- Results Count -->
            <div class="results-info">
                Showing <span id="results-count">{publicationsData.length}</span> of {publicationsData.length} publications
            </div>

            <!-- Publications List -->
            <div class="publications-list" id="publications-list">
                {publicationsData.map((pub, index) => (
                    <article
                        class={`publication-card ${pub.abstract ? 'has-abstract' : ''}`}
                        data-pub-id={pub.id}
                        data-year={pub.year}
                        data-title={pub.title.toLowerCase()}
                        data-authors={pub.authors.toLowerCase()}
                        data-journal={pub.journal.toLowerCase()}
                        data-authorship={pub.authorship}
                        data-abstract={pub.abstract.toLowerCase()}
                        data-type={pub.publicationType}
                        style={`--delay: ${Math.min(index * 0.02, 0.6)}s`}
                    >
                        <div class="pub-number">{index + 1}</div>
                        <div class="pub-content">
                            <h3 class="pub-title">
                                <a href={pub.link} target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">
                                    {pub.title}
                                </a>
                            </h3>
                            <p class="pub-authors">{pub.authors}</p>
                            <div class="pub-meta">
                                <span class="pub-journal">{pub.journal}</span>
                                <span class="pub-year">{pub.year}</span>
                                {pub.publicationType && (
                                    <span class="pub-type">{pub.publicationType}</span>
                                )}
                                {pub.doi && (
                                    <a href={`https://doi.org/${pub.doi}`} class="pub-doi" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">
                                        DOI
                                    </a>
                                )}
                            </div>
                            {pub.abstract && (
                                <div class="pub-abstract">{pub.abstract}</div>
                            )}
                        </div>
                    </article>
                ))}
            </div>
        </div>
    </div>
</Layout>

<script>
    // Publications data for client-side filtering
    const publicationsData = document.querySelectorAll('.publication-card');
    let currentSort = 'year-desc';
    let currentAuthorship = 'all';
    let currentType = 'all';
    let searchKeywords = [];
    let yearMin = parseInt(document.getElementById('year-min').getAttribute('min'));
    let yearMax = parseInt(document.getElementById('year-max').getAttribute('max'));

    // Search functionality - comma-separated keywords
    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', (e) => {
        const value = e.target.value.toLowerCase().trim();
        searchKeywords = value ? value.split(',').map(k => k.trim()).filter(k => k) : [];
        filterAndSort();
    });

    // Sort functionality
    document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentSort = btn.dataset.sort;
            filterAndSort();
        });
    });

    // Authorship filter
    document.querySelectorAll('.authorship-filters .filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
            document.querySelectorAll('.authorship-filters .filter-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            currentAuthorship = chip.dataset.authorship;
            filterAndSort();
        });
    });

    // Publication type filter
    document.querySelectorAll('.type-filters .filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
            document.querySelectorAll('.type-filters .filter-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            currentType = chip.dataset.type;
            filterAndSort();
        });
    });

    // Year range sliders with proper z-index handling
    const yearMinSlider = document.getElementById('year-min');
    const yearMaxSlider = document.getElementById('year-max');
    const yearMinLabel = document.getElementById('year-min-label');
    const yearMaxLabel = document.getElementById('year-max-label');

    // Update z-index based on slider positions to prevent overlap issues
    function updateSliderZIndex() {
        if (yearMin === yearMax) {
            yearMinSlider.style.zIndex = '4';
            yearMaxSlider.style.zIndex = '3';
        } else {
            yearMinSlider.style.zIndex = '2';
            yearMaxSlider.style.zIndex = '3';
        }
    }

    yearMinSlider.addEventListener('mousedown', () => {
        yearMinSlider.style.zIndex = '5';
    });

    yearMinSlider.addEventListener('mouseup', () => {
        updateSliderZIndex();
    });

    yearMaxSlider.addEventListener('mousedown', () => {
        yearMaxSlider.style.zIndex = '5';
    });

    yearMaxSlider.addEventListener('mouseup', () => {
        updateSliderZIndex();
    });

    yearMinSlider.addEventListener('input', (e) => {
        const newMin = parseInt(e.target.value);
        yearMin = Math.min(newMin, yearMax);
        yearMinLabel.textContent = yearMin;
        updateSliderZIndex();
        filterAndSort();
    });

    yearMaxSlider.addEventListener('input', (e) => {
        const newMax = parseInt(e.target.value);
        yearMax = Math.max(newMax, yearMin);
        yearMaxLabel.textContent = yearMax;
        updateSliderZIndex();
        filterAndSort();
    });

    updateSliderZIndex();

    // Card click to toggle abstract
    document.addEventListener('click', (e) => {
        const card = e.target.closest('.publication-card.has-abstract');
        if (card) {
            card.classList.toggle('expanded');
        }
    });

    function filterAndSort() {
        const pubsArray = Array.from(publicationsData);

        // Filter publications
        const filtered = pubsArray.filter(pub => {
            const year = parseInt(pub.dataset.year);
            const authorship = pub.dataset.authorship;
            const type = pub.dataset.type;
            const title = pub.dataset.title;
            const authors = pub.dataset.authors;
            const journal = pub.dataset.journal;
            const abstract = pub.dataset.abstract;
            const searchText = title + ' ' + authors + ' ' + journal + ' ' + year + ' ' + abstract;

            // Year filter
            if (year < yearMin || year > yearMax) return false;

            // Authorship filter - combine first/last into "lead"
            if (currentAuthorship === 'lead') {
                if (authorship !== 'first' && authorship !== 'last') return false;
            } else if (currentAuthorship !== 'all' && authorship !== currentAuthorship) {
                return false;
            }

            // Publication type filter
            if (currentType !== 'all' && type !== currentType) return false;

            // Search filter - all keywords must match
            if (searchKeywords.length > 0) {
                const allMatch = searchKeywords.every(keyword => searchText.includes(keyword));
                if (!allMatch) return false;
            }

            return true;
        });

        // Sort publications
        filtered.sort((a, b) => {
            switch (currentSort) {
                case 'year-desc':
                    return parseInt(b.dataset.year) - parseInt(a.dataset.year);
                case 'year-asc':
                    return parseInt(a.dataset.year) - parseInt(b.dataset.year);
                case 'title':
                    return a.dataset.title.localeCompare(b.dataset.title);
                default:
                    return 0;
            }
        });

        // Update display
        const container = document.getElementById('publications-list');
        pubsArray.forEach(pub => {
            pub.style.display = 'none';
            pub.classList.remove('visible');
        });

        filtered.forEach((pub, index) => {
            pub.style.display = 'flex';
            pub.querySelector('.pub-number').textContent = index + 1;
            setTimeout(() => pub.classList.add('visible'), 10);
            container.appendChild(pub);
        });

        // Update count
        document.getElementById('results-count').textContent = filtered.length;
    }

    // Controls toggle
    const controlsToggle = document.getElementById('controls-toggle');
    const controlsContainer = document.getElementById('controls-container');

    controlsToggle.addEventListener('click', () => {
        const isExpanded = controlsToggle.getAttribute('aria-expanded') === 'true';
        controlsToggle.setAttribute('aria-expanded', !isExpanded);
        controlsContainer.classList.toggle('collapsed');
    });

    // Initial animation
    setTimeout(() => {
        publicationsData.forEach(pub => pub.classList.add('visible'));
    }, 100);
</script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600&display=swap');

    .publications-section {
        margin-top: 3rem;
    }

    /* Controls Wrapper & Toggle */
    .controls-wrapper {
        position: relative;
        margin-bottom: 2rem;
    }

    .controls-toggle-btn {
        position: absolute;
        top: -0.75rem;
        right: 0;
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.75rem;
        background: var(--color-bg);
        border: 1px solid var(--color-border);
        border-radius: 6px;
        color: var(--color-text-muted);
        cursor: pointer;
        transition: all 0.2s ease;
        z-index: 10;
        font-size: 0.85rem;
        font-weight: 500;
        font-family: 'Roboto', sans-serif;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .controls-toggle-btn:hover {
        color: var(--color-accent);
        border-color: var(--color-accent);
    }

    .controls-toggle-btn[aria-expanded="false"] {
        background: var(--color-bg-alt);
    }

    .toggle-arrow {
        transition: transform 0.2s ease;
    }

    .controls-toggle-btn[aria-expanded="false"] .toggle-arrow {
        transform: rotate(-90deg);
    }

    /* Controls */
    .controls-container {
        background: var(--color-bg-alt);
        border: 1px solid var(--color-border);
        border-radius: 8px;
        padding: 1.75rem;
        margin-bottom: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        max-height: 1000px;
        overflow: hidden;
        opacity: 1;
        transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                    opacity 0.3s ease,
                    padding 0.3s ease,
                    margin 0.3s ease,
                    border-color 0.3s ease;
    }

    .controls-container.collapsed {
        max-height: 0;
        opacity: 0;
        padding: 0 1.75rem;
        margin-bottom: 1rem;
        border-color: transparent;
    }

    .control-section {
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
    }

    .filters-row {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .filters-row .control-section {
        flex: 1;
        min-width: 200px;
    }

    .section-label {
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--color-text-muted);
    }

    /* Search Input */
    .search-input {
        padding: 0.7rem 1rem;
        border: 1px solid var(--color-border);
        background: var(--color-bg);
        color: var(--color-text);
        border-radius: 6px;
        font-size: 0.95rem;
        font-family: 'Roboto', sans-serif;
        transition: all 0.2s ease;
        width: 100%;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 2px rgba(26, 26, 26, 0.05);
    }

    .search-input::placeholder {
        color: var(--color-text-muted);
        opacity: 0.6;
    }

    /* Sort Buttons */
    .sort-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        row-gap: 0.65rem;
    }

    .sort-btn {
        padding: 0.5rem 1rem;
        border: 1px solid var(--color-border);
        background: var(--color-bg);
        color: var(--color-text);
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        font-family: 'Roboto', sans-serif;
    }

    .sort-btn:hover {
        border-color: var(--color-accent);
        transform: translateY(-1px);
    }

    .sort-btn.active {
        background: var(--color-accent);
        color: white;
        border-color: var(--color-accent);
    }

    /* Filter Chips */
    .authorship-filters,
    .type-filters {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        row-gap: 0.65rem;
    }

    .filter-chip {
        padding: 0.4rem 0.9rem;
        border: 1px solid var(--color-border);
        background: var(--color-bg);
        color: var(--color-text);
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s ease;
        font-family: 'Roboto', sans-serif;
    }

    .filter-chip:hover {
        border-color: var(--color-accent);
        background: rgba(255, 0, 119, 0.05);
    }

    .filter-chip.active {
        background: var(--color-accent);
        color: white;
        border-color: var(--color-accent);
    }

    /* Year Slider */
    .year-slider-container {
        flex: 1;
        position: relative;
        padding: 0.5rem 0;
    }

    .year-slider {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 4px;
        border-radius: 2px;
        background: transparent;
        outline: none;
        position: relative;
        z-index: 2;
        pointer-events: none;
    }

    .year-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--color-accent);
        cursor: pointer;
        pointer-events: auto;
        transition: all 0.2s ease;
        border: 2px solid var(--color-bg);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
    }

    .year-slider::-webkit-slider-thumb:hover {
        transform: scale(1.15);
    }

    .year-slider::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--color-accent);
        cursor: pointer;
        pointer-events: auto;
        border: 2px solid var(--color-bg);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease;
    }

    .year-slider::-moz-range-thumb:hover {
        transform: scale(1.15);
    }

    .year-track {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--color-border);
        border-radius: 2px;
        transform: translateY(-50%);
        z-index: 1;
    }

    .year-slider:first-of-type {
        position: absolute;
        top: 0.5rem;
        left: 0;
    }

    .year-slider:last-of-type {
        position: absolute;
        top: 0.5rem;
        left: 0;
    }

    .year-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 1.5rem;
        font-size: 0.85rem;
        color: var(--color-text-muted);
        font-weight: 500;
        font-variant-numeric: tabular-nums;
    }

    /* Results Info */
    .results-info {
        font-size: 0.9rem;
        color: var(--color-text-muted);
        margin-bottom: 1.5rem;
        padding-left: 0.25rem;
    }

    #results-count {
        font-weight: 600;
        color: var(--color-primary);
    }

    /* Publications List */
    .publications-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .publication-card {
        display: flex;
        gap: 1.5rem;
        padding: 1.5rem;
        background: var(--color-bg-alt);
        border: 1px solid var(--color-border);
        border-radius: 8px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
        transform: translateY(20px);
    }

    .publication-card.visible {
        opacity: 1;
        transform: translateY(0);
        transition-delay: var(--delay);
    }

    .publication-card.has-abstract {
        cursor: pointer;
    }

    .publication-card:hover {
        border-color: var(--color-accent);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .pub-number {
        flex-shrink: 0;
        width: 2.5rem;
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Crimson Pro', serif;
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--color-text-muted);
        opacity: 0.8;
    }

    .pub-content {
        flex: 1;
        min-width: 0;
    }

    .pub-title {
        margin: 0 0 0.6rem 0;
        font-size: 1.05rem;
        font-weight: 600;
        line-height: 1.5;
    }

    .pub-title a {
        color: var(--color-primary);
        text-decoration: none;
        transition: color 0.2s ease;
        display: inline;
    }

    .pub-title a:hover {
        color: var(--color-accent);
    }

    .pub-authors {
        margin: 0 0 0.85rem 0;
        font-size: 0.9rem;
        color: var(--color-text-muted);
        line-height: 1.6;
    }

    .pub-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.65rem;
        align-items: center;
        font-size: 0.85rem;
    }

    .pub-journal {
        font-style: italic;
        color: var(--color-text);
    }

    .pub-year {
        color: var(--color-text-muted);
        font-weight: 500;
        font-variant-numeric: tabular-nums;
    }

    .pub-type {
        padding: 0.2rem 0.6rem;
        background: var(--color-border);
        color: var(--color-text-muted);
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        white-space: nowrap;
    }

    .pub-doi {
        padding: 0.2rem 0.6rem;
        background: rgba(255, 0, 119, 0.1);
        color: var(--color-accent);
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .pub-doi:hover {
        background: var(--color-accent);
        color: white;
    }

    /* Abstract */
    .pub-abstract {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                    margin-top 0.3s ease,
                    opacity 0.3s ease;
        font-size: 0.9rem;
        line-height: 1.7;
        color: var(--color-text-muted);
        opacity: 0;
        padding-top: 0;
        border-top: 0px solid var(--color-border);
    }

    .publication-card.expanded .pub-abstract {
        max-height: 1000px;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--color-border);
        opacity: 1;
    }

    .publication-card.has-abstract:hover .pub-number {
        color: var(--color-accent);
        opacity: 1;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .controls-container {
            padding: 1.25rem;
        }

        .filters-row {
            flex-direction: column;
            gap: 1.25rem;
        }

        .filters-row .control-section {
            min-width: 100%;
        }

        .publication-card {
            flex-direction: column;
            gap: 1rem;
            padding: 1.25rem;
        }

        .pub-number {
            align-self: flex-start;
        }

        .sort-buttons,
        .authorship-filters {
            width: 100%;
        }

        .sort-btn,
        .filter-chip {
            flex: 1;
            text-align: center;
            min-width: max-content;
        }
    }
</style>
