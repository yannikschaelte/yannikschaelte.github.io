---
import Layout from '../layouts/Layout.astro';
import { SITE_DATA } from '../constants';
import publicationsData from '../data/publications.json';

import '../styles/publications.css';

// Extract years for filters
const years = [...new Set(publicationsData.map(pub => pub.year))].sort((a, b) => b - a);
const minYear = Math.min(...years);
const maxYear = Math.max(...years);

// Extract unique publication types
const publicationTypes = [...new Set(publicationsData.map(pub => pub.publicationType).filter(Boolean))];
---

<Layout pageTitle="Publications">
    <div class="page-container">
        <h1>Publications</h1>

        <div class="info-card">
            <p>
                For an up-to-date list of my peer-reviewed publications and preprints, see:
            </p>
            <a href={`https://scholar.google.com/citations?user=${SITE_DATA.scholar}`}
               class="info-card-link"
               target="_blank"
               rel="noopener noreferrer"
               aria-label="Visit Google Scholar profile">
                <svg viewBox="0 0 24 24" width="60" height="60" fill="currentColor">
                    <path d="M12 2L1 7l11 5 9-4.09V17h2V7L12 2z"></path>
                    <path d="M19 11v6c0 1.66-3.13 3-7 3s-7-1.34-7-3v-6l7 3 7-3z"></path>
                </svg>
                <span>Google Scholar</span>
            </a>
        </div>

        <div class="publications-section">
            <!-- Controls -->
            <div class="controls-wrapper">
                <button class="controls-toggle-btn" id="controls-toggle" aria-expanded="false" aria-label="Toggle filters">
                    <span class="toggle-label">Filters</span>
                    <svg class="toggle-arrow" viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                        <path d="M7 10l5 5 5-5z"/>
                    </svg>
                </button>
                <div class="controls-container collapsed" id="controls-container">
                <!-- Search -->
                <div class="control-section">
                    <label class="section-label">Search</label>
                    <input
                        type="text"
                        id="search-input"
                        class="search-input"
                        placeholder="Keywords (comma-separated)"
                    />
                </div>

                <!-- Filters Row -->
                <div class="filters-row">
                    <!-- Sort -->
                    <div class="control-section">
                        <label class="section-label">Sort</label>
                        <div class="sort-buttons">
                            <button class="sort-btn active" data-sort="year-desc">Newest</button>
                            <button class="sort-btn" data-sort="year-asc">Oldest</button>
                            <button class="sort-btn" data-sort="title">A-Z</button>
                        </div>
                    </div>

                    <!-- Authorship -->
                    <div class="control-section">
                        <label class="section-label">Authorship</label>
                        <div class="authorship-filters">
                            <button class="filter-chip active" data-authorship="all">All</button>
                            <button class="filter-chip" data-authorship="lead">First/Last</button>
                            <button class="filter-chip" data-authorship="other">Co</button>
                        </div>
                    </div>

                    <!-- Publication Type -->
                    <div class="control-section">
                        <label class="section-label">Type</label>
                        <div class="type-filters">
                            <button class="filter-chip active" data-type="all">All</button>
                            {publicationTypes.map(type => (
                                <button class="filter-chip" data-type={type}>{type}</button>
                            ))}
                        </div>
                    </div>
                </div>

                <!-- Year Range -->
                <div class="control-section">
                    <label class="section-label">Year Range</label>
                    <div class="year-slider-container">
                        <input type="range" id="year-min" class="year-slider" min={minYear} max={maxYear} value={minYear} />
                        <input type="range" id="year-max" class="year-slider" min={minYear} max={maxYear} value={maxYear} />
                        <div class="year-track"></div>
                        <div class="year-labels">
                            <span id="year-min-label">{minYear}</span>
                            <span id="year-max-label">{maxYear}</span>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- Results Count -->
            <div class="results-info">
                Showing <span id="results-count">{publicationsData.length}</span> of {publicationsData.length} publications
            </div>

            <!-- Publications List -->
            <div class="publications-list" id="publications-list">
                {publicationsData.map((pub, index) => (
                    <article
                        class={`publication-card ${pub.abstract ? 'has-abstract' : ''}`}
                        data-pub-id={pub.id}
                        data-year={pub.year}
                        data-title={pub.title.toLowerCase()}
                        data-authors={pub.authors.toLowerCase()}
                        data-journal={pub.journal.toLowerCase()}
                        data-authorship={pub.authorship}
                        data-abstract={pub.abstract.toLowerCase()}
                        data-type={pub.publicationType}
                        style={`--delay: ${Math.min(index * 0.02, 0.6)}s`}
                    >
                        <div class="pub-number">{index + 1}</div>
                        <div class="pub-content">
                            <h3 class="pub-title">
                                <a href={pub.link} target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">
                                    {pub.title}
                                </a>
                            </h3>
                            <p class="pub-authors">{pub.authors}</p>
                            <div class="pub-meta">
                                <span class="pub-journal">{pub.journal}</span>
                                <span class="pub-year">{pub.year}</span>
                                {pub.publicationType && (
                                    <span class="pub-type">{pub.publicationType}</span>
                                )}
                                {pub.doi && (
                                    <a href={`https://doi.org/${pub.doi}`} class="pub-doi" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">
                                        DOI
                                    </a>
                                )}
                            </div>
                            {pub.abstract && (
                                <div class="pub-abstract">{pub.abstract}</div>
                            )}
                        </div>
                    </article>
                ))}
            </div>
        </div>
    </div>
</Layout>

<script>
    // Publications data for client-side filtering
    const publicationsData = document.querySelectorAll('.publication-card');
    let currentSort = 'year-desc';
    let currentAuthorship = 'all';
    let currentType = 'all';
    let searchKeywords = [];
    let yearMin = parseInt(document.getElementById('year-min').getAttribute('min'));
    let yearMax = parseInt(document.getElementById('year-max').getAttribute('max'));

    // Search functionality - comma-separated keywords
    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', (e) => {
        const value = e.target.value.toLowerCase().trim();
        searchKeywords = value ? value.split(',').map(k => k.trim()).filter(k => k) : [];
        filterAndSort();
    });

    // Sort functionality
    document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentSort = btn.dataset.sort;
            filterAndSort();
        });
    });

    // Authorship filter
    document.querySelectorAll('.authorship-filters .filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
            document.querySelectorAll('.authorship-filters .filter-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            currentAuthorship = chip.dataset.authorship;
            filterAndSort();
        });
    });

    // Publication type filter
    document.querySelectorAll('.type-filters .filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
            document.querySelectorAll('.type-filters .filter-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            currentType = chip.dataset.type;
            filterAndSort();
        });
    });

    // Year range sliders with proper z-index handling
    const yearMinSlider = document.getElementById('year-min');
    const yearMaxSlider = document.getElementById('year-max');
    const yearMinLabel = document.getElementById('year-min-label');
    const yearMaxLabel = document.getElementById('year-max-label');

    // Update z-index based on slider positions to prevent overlap issues
    function updateSliderZIndex() {
        if (yearMin === yearMax) {
            yearMinSlider.style.zIndex = '4';
            yearMaxSlider.style.zIndex = '3';
        } else {
            yearMinSlider.style.zIndex = '2';
            yearMaxSlider.style.zIndex = '3';
        }
    }

    yearMinSlider.addEventListener('mousedown', () => {
        yearMinSlider.style.zIndex = '5';
    });

    yearMinSlider.addEventListener('mouseup', () => {
        updateSliderZIndex();
    });

    yearMaxSlider.addEventListener('mousedown', () => {
        yearMaxSlider.style.zIndex = '5';
    });

    yearMaxSlider.addEventListener('mouseup', () => {
        updateSliderZIndex();
    });

    yearMinSlider.addEventListener('input', (e) => {
        const newMin = parseInt(e.target.value);
        yearMin = Math.min(newMin, yearMax);
        yearMinLabel.textContent = yearMin;
        updateSliderZIndex();
        filterAndSort();
    });

    yearMaxSlider.addEventListener('input', (e) => {
        const newMax = parseInt(e.target.value);
        yearMax = Math.max(newMax, yearMin);
        yearMaxLabel.textContent = yearMax;
        updateSliderZIndex();
        filterAndSort();
    });

    updateSliderZIndex();

    // Card click to toggle abstract
    document.addEventListener('click', (e) => {
        const card = e.target.closest('.publication-card.has-abstract');
        if (card) {
            card.classList.toggle('expanded');
        }
    });

    function filterAndSort() {
        const pubsArray = Array.from(publicationsData);

        // Filter publications
        const filtered = pubsArray.filter(pub => {
            const year = parseInt(pub.dataset.year);
            const authorship = pub.dataset.authorship;
            const type = pub.dataset.type;
            const title = pub.dataset.title;
            const authors = pub.dataset.authors;
            const journal = pub.dataset.journal;
            const abstract = pub.dataset.abstract;
            const searchText = title + ' ' + authors + ' ' + journal + ' ' + year + ' ' + abstract;

            // Year filter
            if (year < yearMin || year > yearMax) return false;

            // Authorship filter - combine first/last into "lead"
            if (currentAuthorship === 'lead') {
                if (authorship !== 'first' && authorship !== 'last') return false;
            } else if (currentAuthorship !== 'all' && authorship !== currentAuthorship) {
                return false;
            }

            // Publication type filter
            if (currentType !== 'all' && type !== currentType) return false;

            // Search filter - all keywords must match
            if (searchKeywords.length > 0) {
                const allMatch = searchKeywords.every(keyword => searchText.includes(keyword));
                if (!allMatch) return false;
            }

            return true;
        });

        // Sort publications
        filtered.sort((a, b) => {
            switch (currentSort) {
                case 'year-desc':
                    return parseInt(b.dataset.year) - parseInt(a.dataset.year);
                case 'year-asc':
                    return parseInt(a.dataset.year) - parseInt(b.dataset.year);
                case 'title':
                    return a.dataset.title.localeCompare(b.dataset.title);
                default:
                    return 0;
            }
        });

        // Update display
        const container = document.getElementById('publications-list');
        pubsArray.forEach(pub => {
            pub.style.display = 'none';
            pub.classList.remove('visible');
        });

        filtered.forEach((pub, index) => {
            pub.style.display = 'flex';
            pub.querySelector('.pub-number').textContent = index + 1;
            setTimeout(() => pub.classList.add('visible'), 10);
            container.appendChild(pub);
        });

        // Update count
        document.getElementById('results-count').textContent = filtered.length;
    }

    // Controls toggle
    const controlsToggle = document.getElementById('controls-toggle');
    const controlsContainer = document.getElementById('controls-container');

    controlsToggle.addEventListener('click', () => {
        const isExpanded = controlsToggle.getAttribute('aria-expanded') === 'true';
        controlsToggle.setAttribute('aria-expanded', !isExpanded);
        controlsContainer.classList.toggle('collapsed');
    });

    // Apply initial sort and filter
    filterAndSort();
</script>
